name: Update Dumps

on:
  workflow_dispatch:
  push:
    paths:
      - 'cache_version'
    branches:
      - main

jobs:
  build-runelite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RuneLite repository
        uses: actions/checkout@v5
        with:
          repository: 'Pauwelz/runelite'
          ref: 'master'
          path: ./runelite
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'
      - name: Build RuneLite (cache module + dependencies)
        run: |
          cd runelite/cache
          mvn -q -DskipTests package
      - name: Collect artifacts
        run: |
          mkdir -p staging
          cp runelite/cache/target/cache-*.jar staging/
          #ls -la runelite/cache/target | grep cache || true
          # List classes inside fat jar (presence expected from Torwent/runelite repo)
          #jar tf $(echo runelite/cache/target/cache-*-SNAPSHOT-jar-with-dependencies.jar | awk '{print $1}') | grep SimbaItemDumper || true
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runelite-jars
          path: staging

  fetch-openrs2:
    runs-on: ubuntu-latest
    outputs:
      cache_version: ${{ steps.read-version.outputs.VERSION }}
    steps:
      - name: Checkout Wasp Data repository
        uses: actions/checkout@v5
      - name: Read cache version
        id: read-version
        run: echo "VERSION=$(cat cache_version)" >> $GITHUB_OUTPUT
      - name: Restore/OpenRS2 cache
        uses: actions/cache@v4
        id: openrs2-cache
        with:
          path: openrs2/cache.zip
          key: openrs2-cache-${{ steps.read-version.outputs.VERSION }}
      - name: Download OpenRS2 (miss)
        if: steps.openrs2-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p openrs2
          curl -L -o openrs2/cache.zip https://archive.openrs2.org/caches/runescape/${{ steps.read-version.outputs.VERSION }}/disk.zip
      - name: Extract OpenRS2
        run: |
          mkdir -p openrs2/cache/input/${{ steps.read-version.outputs.VERSION }}
          unzip -o openrs2/cache.zip -d openrs2/cache/input/${{ steps.read-version.outputs.VERSION }}
          curl -L -o openrs2/keys.json https://archive.openrs2.org/caches/runescape/${{ steps.read-version.outputs.VERSION }}/keys.json
          mv openrs2/keys.json openrs2/cache/input/${{ steps.read-version.outputs.VERSION }}/${{ steps.read-version.outputs.VERSION }}.json
      - name: Upload OpenRS2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrs2-${{ steps.read-version.outputs.VERSION }}
          path: openrs2/cache/input/${{ steps.read-version.outputs.VERSION }}

  dump-items:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaItemDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Items
        uses: actions/upload-artifact@v4
        with:
          name: items-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/items

  dump-collisionmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaCollisionMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaCollisionMapDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Collision Maps
        uses: actions/upload-artifact@v4
        with:
          name: collision-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/collision

          
  dump-heightmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaHeightMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaHeightMapDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Height Maps
        uses: actions/upload-artifact@v4
        with:
          name: heightmap-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/heightmap

  dump-itemsprites:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaItemSpritesDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemSpritesDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Item Sprites
        uses: actions/upload-artifact@v4
        with:
          name: itemsprites-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}

  dump-mapimage:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaMapImageDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaMapImageDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Map Images
        uses: actions/upload-artifact@v4
        with:
          name: map-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/map

  dump-npcs:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaNPCDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaNPCDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload NPCs
        uses: actions/upload-artifact@v4
        with:
          name: npcs-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/NPCs

  dump-objectinfo:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaObjectInfoDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaObjectInfoDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: objects-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/objects

  dump-sprites:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
      - name: Show artifact contents
        run: ls -la staging
      - name: Run SimbaSpriteDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaSpriteDumper \
            --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: sprites-${{ needs.fetch-openrs2.outputs.cache_version }}
          path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}/Sprites

#   dump-cache:
#     runs-on: ubuntu-latest
#     needs: [build-runelite, fetch-openrs2]
#     steps:
#       - name: Setup Java 11
#         uses: actions/setup-java@v4
#         with:
#           distribution: 'temurin'
#           java-version: '11'
#       - name: Download RuneLite artifacts
#         uses: actions/download-artifact@v4
#         with:
#           name: runelite-jars
#           path: staging
#       - name: Download OpenRS2 artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: openrs2-${{ needs.fetch-openrs2.outputs.cache_version }}
#           path: cache/input/${{ needs.fetch-openrs2.outputs.cache_version }}
#       - name: Show artifact contents
#         run: ls -la staging
#       - name: Run SimbaCacheDumper (java)
#         run: |
#           mkdir -p cache/output
#           java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaCacheDumper \
#             --cachedir cache/input --cachename ${{ needs.fetch-openrs2.outputs.cache_version }} --outputdir cache/output || echo "SimbaCacheDumper finished"
#       - name: Upload Items
#         uses: actions/upload-artifact@v4
#         with:
#           name: cache-${{ needs.fetch-openrs2.outputs.cache_version }}
#           path: cache/output/${{ needs.fetch-openrs2.outputs.cache_version }}