name: Update Item Cache

on:
    schedule:
        - cron: '0 0 * * 0'  # Runs every Sunday at midnight
    workflow_dispatch: # Allows manual triggering of the workflow
        

jobs:
    build-runelite:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Wasp Data repository
              uses: actions/checkout@v5
            - name: Checkout RuneLite repository
              uses: actions/checkout@v5
              with:
                repository: 'runelite/runelite'
                ref: 'master'
                path: ./runelite
            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '11'
            - name: Cache local Maven repository
              uses: actions/cache@v4
              with:
                  path: ~/.m2/repository
                  key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
                  restore-keys: |
                    ${{ runner.os }}-maven-
            - name: Copy SimbaItemDumper.java
              run: |
                  cp tools/dumpers/SimbaItemDumper.java runelite/cache/src/main/java/net/runelite/cache/SimbaItemDumper.java
            - name: Build RuneLite
              run: |
                  cd runelite/cache
                  mvn clean package -DskipTests
            - name: Cache OpenRS2 files
              uses: actions/cache@v4
              id: cache-openrs2
              with:
                path: |
                  cache.zip
                  cache/input
                key: openrs2-cache-2349
            - name: OpenRS2 Cache download
              if: steps.cache-openrs2.outputs.cache-hit != 'true'
              run : |
                  mkdir -p cache/input
                  curl -L -o cache.zip https://archive.openrs2.org/caches/runescape/2349/disk.zip
                  unzip -o cache.zip -d cache/input/2349
                  curl -L -o cache/input/2349/keys.json https://archive.openrs2.org/caches/runescape/2349/keys.json
            - name: Extract cached zip if needed
              if: steps.cache-openrs2.outputs.cache-hit == 'true'
              run: |
                  mkdir -p cache/input
                  if [ ! -d "cache/input/cache" ]; then
                    unzip -o cache.zip -d cache/input
                  fi           
            - name: Run SimbaItemDumper
              run: |
                mkdir -p cache/output
                cd runelite/cache
                # Use Maven exec from cache module - full build ensures all dependencies are available
                mvn -q org.codehaus.mojo:exec-maven-plugin:3.1.0:java \
                  -Dexec.mainClass=net.runelite.cache.SimbaItemDumper \
                  -Dexec.classpathScope=compile \
                  -Dexec.args="--cachedir ../cache/input --cachename 2349 --outputdir ../cache/output"
            - uses: actions/upload-artifact@v4
              with:
                name: Items
                path: cache/output/2349/items