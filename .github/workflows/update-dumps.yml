name: Update Dumps

on:
  workflow_dispatch:
    inputs:
      cache_version:
        description: 'OpenRS2 cache version to process'
        required: true
        type: string
  workflow_call:
    inputs:
      cache_version:
        description: 'OpenRS2 cache version to process'
        required: true
        type: string
        

run-name: Update Dumps for OpenRS2 cache version ${{ inputs.cache_version }}

jobs:
  build-runelite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RuneLite repository
        uses: actions/checkout@v5
        with:
          repository: 'Torwent/runelite'
          ref: 'main'
          path: ./runelite
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'
      - name: Build RuneLite (cache module + dependencies)
        run: |
          cd runelite/cache
          mvn -q -DskipTests package
      - name: Build RuneLite (cache module + dependencies)
        run: |
          cd runelite/runelite-client
          mvn -q -DskipTests package
      - name: Copy to staging
        run: |
          mkdir -p staging
          cp runelite/cache/target/cache-*-SNAPSHOT-jar-with-dependencies.jar staging/
          cp runelite/runelite-client/target/*-shaded.jar staging/
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runelite-jars
          path: staging/

  fetch-openrs2:
    runs-on: ubuntu-latest
    steps:
      - name: Restore/OpenRS2 cache
        uses: actions/cache@v4
        id: openrs2-cache
        with:
          path: openrs2/cache/input
          key: openrs2-cache-${{ inputs.cache_version }}
      - name: Download OpenRS2 (miss)
        if: steps.openrs2-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p openrs2/cache/input/${{ inputs.cache_version }}
          curl -L -o disk.zip https://archive.openrs2.org/caches/runescape/${{ inputs.cache_version }}/disk.zip
          unzip -o disk.zip -d openrs2/cache/input/${{ inputs.cache_version }}
      - name: Fetch latest OpenRS2 keys.json
        run: |
          curl -L -o openrs2/cache/input/${{ inputs.cache_version }}/${{ inputs.cache_version }}.json https://archive.openrs2.org/caches/runescape/${{ inputs.cache_version }}/keys.json
      - name: Upload OpenRS2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: openrs2/cache/input/${{ inputs.cache_version }}

  dump-itemfinder:
    runs-on: windows-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Checkout RuneLite repository
        uses: actions/checkout@v5
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
      - name: Copy cache
        run: |
          $jagexCacheDir = "$env:USERPROFILE\jagexcache\oldschool\LIVE"
          New-Item -ItemType Directory -Force -Path $jagexCacheDir | Out-Null
          Copy-Item -Recurse -Force "openrs2-${{ inputs.cache_version }}/cache/*" $jagexCacheDir
          $runeliteCacheDir = "$env:USERPROFILE\.runelite\jagexcache\oldschool\LIVE"
          New-Item -ItemType Directory -Force -Path $runeliteCacheDir | Out-Null
          Copy-Item -Recurse -Force "openrs2-${{ inputs.cache_version }}/cache/*" $runeliteCacheDir
      - name: Copy preferences.dat
        run: |
          $jagexCacheDir = "$env:USERPROFILE\jagexcache\oldschool\LIVE"
          New-Item -ItemType Directory -Force -Path $jagexCacheDir | Out-Null
          Copy-Item -Recurse -Force "tools/preferences/*.dat" $jagexCacheDir
          $runeliteCacheDir = "$env:USERPROFILE\.runelite\jagexcache\oldschool\LIVE"
          New-Item -ItemType Directory -Force -Path $runeliteCacheDir | Out-Null
          Copy-Item -Recurse -Force "tools/preferences/*.dat" $runeliteCacheDir
      - name: Run RuneLite (java)
        run: |
          $jar = Get-ChildItem runelite-jars -Filter "*-shaded.jar" | Select-Object -First 1
          if (-not $jar) { Write-Error "Shaded jar not found"; exit 1 }
          $process = Start-Process -FilePath "java" -ArgumentList "-jar", $jar.FullName -NoNewWindow -PassThru -RedirectStandardOutput "output.log" -RedirectStandardError "error.log"
          $timeout = 300
          $elapsed = 0
          while (-not $process.HasExited -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds 5
            $elapsed += 5
            if (Test-Path "output.log") {
              $content = Get-Content "output.log" -Raw
              if ($content -match "ItemFinder completed") {
                Write-Host "ItemFinder completed detected, stopping process"
                Stop-Process -Id $process.Id -Force
                break
              }
            }
          }
          if ($elapsed -ge $timeout) {
            Write-Host "Timeout reached, stopping process"
            Stop-Process -Id $process.Id -Force
          }
          Get-Content "output.log" -ErrorAction SilentlyContinue
          Get-Content "error.log" -ErrorAction SilentlyContinue
      - name: Upload ItemFinder
        uses: actions/upload-artifact@v4
        with:
          name: itemfinder
          path: itemfinder

  dump-items:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaItemDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
          cd cache/output/${{ inputs.cache_version }}/items
          zip -r items.zip ./*.json
      - name: Upload Items
        uses: actions/upload-artifact@v4
        with:
          name: items
          path: cache/output/${{ inputs.cache_version }}/items/items.zip

  dump-collisionmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaCollisionMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaCollisionMapDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Collision Maps
        uses: actions/upload-artifact@v4
        with:
          name: collision
          path: cache/output/${{ inputs.cache_version }}

          
  dump-heightmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaHeightMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaHeightMapDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Height Maps
        uses: actions/upload-artifact@v4
        with:
          name: heightmap
          path: cache/output/${{ inputs.cache_version }}/heightmap.zip

  # dump-itemsprites:
  #   runs-on: ubuntu-latest
  #   needs: [build-runelite, fetch-openrs2]
  #   steps:
  #     - name: Setup Java 11
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '11'
  #     - name: Download RuneLite artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: runelite-jars
  #         path: staging
  #     - name: Download OpenRS2 artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: openrs2-${{ inputs.cache_version }}
  #         path: cache/input/${{ inputs.cache_version }}
  #     - name: Run SimbaItemSpritesDumper (java)
  #       run: |
  #         mkdir -p cache/output
  #         java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemSpritesDumper \
  #           --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
  #     - name: Upload Item Sprites
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: itemsprites
  #         path: cache/output/${{ inputs.cache_version }}

  dump-mapimage:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaMapImageDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaMapImageDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Map Images
        uses: actions/upload-artifact@v4
        with:
          name: map
          path: cache/output/${{ inputs.cache_version }}

  dump-npcs:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaNPCDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaNPCDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Zip NPCs folder
        run: |
            cd cache/output/${{ inputs.cache_version }}/NPCs
            zip -r npcs.zip .
      - name: Upload NPCs
        uses: actions/upload-artifact@v4
        with:
          name: npcs
          path: cache/output/${{ inputs.cache_version }}/NPCs/npcs.zip

  dump-objectinfo:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaObjectInfoDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaObjectInfoDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: objects
          path: cache/output/${{ inputs.cache_version }}

  dump-sprites:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaSpriteDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaSpriteDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: sprites
          path: cache/output/${{ inputs.cache_version }}

  commit-results:
    runs-on: ubuntu-latest
    needs: [dump-items, dump-collisionmap, dump-heightmap, dump-mapimage, dump-npcs, dump-objectinfo, dump-sprites, dump-itemfinder]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Download all dump artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Organize dump outputs
        run: |
          mv artifacts/itemfinder/items-imgs.zip finders/items/items-imgs.zip
          mv artifacts/itemfinder/id.txt finders/items/data/id.txt
          mv artifacts/itemfinder/item.txt finders/items/data/item.txt
          mv artifacts/items/items.zip jsons/item-definitions.zip
          mv artifacts/npcs/npcs.zip map/npcs_helper.zip
          mv artifacts/map/map.zip map/map.zip
          mv artifacts/objects/objects.zip map/objects.zip
          mv artifacts/collision/collision.zip map/collision.zip
          mv artifacts/heightmap/heightmap.zip map/heightmap.zip
          rm -r artifacts/
      # - name: Create branch and commit
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git checkout -b update-${{ inputs.cache_version }}
      #     git add -u
      #     git commit -m "Add cache dumps for OpenRS2 version ${{ inputs.cache_version }}" || echo "No changes to commit"
      #     git push origin update-${{ inputs.cache_version }} --force
      # - name: Check if PR exists
      #   id: check
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     prs=$(gh pr list \
      #         --repo "$GITHUB_REPOSITORY" \
      #         --head 'update-${{ inputs.cache_version }}' \
      #         --base 'main' \
      #         --json title \
      #         --jq 'length')
      #     if ((prs > 0)); then
      #         echo "skip=true" >> "$GITHUB_OUTPUT"
      #     fi
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: update-${{ inputs.cache_version }}
          title: "Update cache dumps to version ${{ inputs.cache_version }}"
          base: main
          body: |
            Automated cache dump update from OpenRS2 archive.
            
            **Cache Version:** ${{ inputs.cache_version }}
            
            Generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: automated,cache-update