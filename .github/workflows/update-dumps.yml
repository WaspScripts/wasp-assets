name: Update Dumps

on:
  workflow_dispatch:
    inputs:
      cache_version:
        description: 'OpenRS2 cache version to process'
        required: true
        type: string
  workflow_call:
    inputs:
      cache_version:
        description: 'OpenRS2 cache version to process'
        required: true
        type: string
        

run-name: Update Dumps for OpenRS2 cache version ${{ inputs.cache_version }}

jobs:
  build-runelite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RuneLite repository
        uses: actions/checkout@v5
        with:
          repository: 'Torwent/runelite'
          ref: 'main'
          path: ./runelite
      # - name: Checkout Torwent/RuneLite repository
      #   uses: actions/checkout@v5
      #   with:
      #       repository: 'Torwent/runelite'
      #       ref: 'main'
      #       path: ./torwent-runelite
      # - name: Copy Simba*Dumper.java
      #   run: |
      #       cp torwent-runelite/cache/src/main/java/net/runelite/cache/Simba*.java runelite/cache/src/main/java/net/runelite/cache/
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'
      - name: Build RuneLite (cache module + dependencies)
        run: |
          cd runelite/cache
          mvn -q -DskipTests package
      - name: Collect artifacts
        run: |
          mkdir -p staging
          cp runelite/cache/target/cache-*.jar staging/
          #ls -la runelite/cache/target | grep cache || true
          # List classes inside fat jar (presence expected from Torwent/runelite repo)
          #jar tf $(echo runelite/cache/target/cache-*-SNAPSHOT-jar-with-dependencies.jar | awk '{print $1}') | grep SimbaItemDumper || true
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runelite-jars
          path: staging

  fetch-openrs2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Wasp Data repository
        uses: actions/checkout@v5
      - name: Restore/OpenRS2 cache
        uses: actions/cache@v4
        id: openrs2-cache
        with:
          path: openrs2/cache/input
          key: openrs2-cache-${{ inputs.cache_version }}
      - name: Download OpenRS2 (miss)
        if: steps.openrs2-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p openrs2/cache/input/${{ inputs.cache_version }}
          curl -L -o disk.zip https://archive.openrs2.org/caches/runescape/${{ inputs.cache_version }}/disk.zip
          unzip -o disk.zip -d openrs2/cache/input/${{ inputs.cache_version }}
      - name: Fetch latest OpenRS2 keys.json
        run: |
          curl -L -o openrs2/cache/input/${{ inputs.cache_version }}/${{ inputs.cache_version }}.json https://archive.openrs2.org/caches/runescape/${{ inputs.cache_version }}/keys.json
      - name: Upload OpenRS2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: openrs2/cache/input/${{ inputs.cache_version }}

  dump-items:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaItemDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Zip item definitions
        run: |
            cd cache/output/${{ inputs.cache_version }}
            zip -r item-definitions.zip items/*
      - name: Upload Items
        uses: actions/upload-artifact@v4
        with:
          name: items-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}/item-definitions.zip

  dump-collisionmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaCollisionMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaCollisionMapDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Collision Maps
        uses: actions/upload-artifact@v4
        with:
          name: collision-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}

          
  dump-heightmap:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaHeightMapDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaHeightMapDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Zip item definitions
        run: |
            cd cache/output/${{ inputs.cache_version }}
            zip -r heightmap.zip heightmap/*
      - name: Upload Height Maps
        uses: actions/upload-artifact@v4
        with:
          name: heightmap-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}/heightmap.zip

  dump-itemsprites:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaItemSpritesDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaItemSpritesDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Item Sprites
        uses: actions/upload-artifact@v4
        with:
          name: itemsprites-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}

  dump-mapimage:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaMapImageDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaMapImageDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Map Images
        uses: actions/upload-artifact@v4
        with:
          name: map-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}

  dump-npcs:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaNPCDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaNPCDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Zip NPCs
        run: |
            cd cache/output/${{ inputs.cache_version }}
            zip -r npcs.zip NPCs
      - name: Upload NPCs
        uses: actions/upload-artifact@v4
        with:
          name: npcs-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}/npcs.zip

  dump-objectinfo:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaObjectInfoDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaObjectInfoDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: objects-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}

  dump-sprites:
    runs-on: ubuntu-latest
    needs: [build-runelite, fetch-openrs2]
    steps:
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - name: Download RuneLite artifacts
        uses: actions/download-artifact@v4
        with:
          name: runelite-jars
          path: staging
      - name: Download OpenRS2 artifact
        uses: actions/download-artifact@v4
        with:
          name: openrs2-${{ inputs.cache_version }}
          path: cache/input/${{ inputs.cache_version }}
      - name: Run SimbaSpriteDumper (java)
        run: |
          mkdir -p cache/output
          java -cp staging/cache-*-SNAPSHOT-jar-with-dependencies.jar net.runelite.cache.SimbaSpriteDumper \
            --cachedir cache/input --cachename ${{ inputs.cache_version }} --outputdir cache/output
      - name: Upload Object Info
        uses: actions/upload-artifact@v4
        with:
          name: sprites-${{ inputs.cache_version }}
          path: cache/output/${{ inputs.cache_version }}

  commit-results:
    runs-on: windows-latest
    needs: [dump-items, dump-collisionmap, dump-heightmap, dump-itemsprites, dump-mapimage, dump-npcs, dump-objectinfo, dump-sprites]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Download all dump artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Organize dump outputs
        run: |
          New-Item -ItemType Directory -Force -Path jsons | Out-Null
          New-Item -ItemType Directory -Force -Path map | Out-Null
          $cv = "${{ inputs.cache_version }}"
          $moves = @(
            @{Source="artifacts/items-$cv/item-definitions.zip"; Dest="jsons/item-definitions.zip"},
            @{Source="artifacts/collision-$cv/collision.zip"; Dest="map/collision.zip"},
            @{Source="artifacts/heightmap-$cv/heightmap.zip"; Dest="map/heightmap.zip"},
            @{Source="artifacts/npcs-$cv/npcs.zip"; Dest="map/npcs_helper.zip"},
            @{Source="artifacts/map-$cv/map.zip"; Dest="map/map.zip"}
          )
          foreach ($m in $moves) {
            if (Test-Path $m.Source) {
              Write-Host "Moving $($m.Source) -> $($m.Dest)"
              Move-Item -Force $m.Source $m.Dest
            } else {
              Write-Host "Source not found (skipping): $($m.Source)"
            }
          }
      - name: Download Simba binary
        run: |
          $latestUrlFile = "https://raw.githubusercontent.com/Villavu/Simba-Build-Archive/refs/heads/main/latest.win64"
          $simbaZipUrl = (Invoke-WebRequest -Uri $latestUrlFile -UseBasicParsing).Content.Trim()
          Invoke-WebRequest -Uri $simbaZipUrl -OutFile simba.zip
          Invoke-WebRequest -Uri https://github.com/Villavu/Simba/releases/download/simba1400-release/Simba-Win64.exe -OutFile Simba-1400.exe
          Expand-Archive -Path simba.zip -DestinationPath simba -Force
      - name: Run Simba to extract additional assets
        run: |
          $exe = Get-ChildItem . -Filter "Simba-1400*.exe" | Select-Object -First 1
          & $exe.FullName --run tools/hash-files.simba
          & $exe.FullName --run tools/update_gear.simba
          & $exe.FullName --run tools/update_items.simba
          & $exe.FullName --run tools/update_npcs.simba
      - name: Create branch and commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b update-${{ inputs.cache_version }}
          git add -u
          git commit -m "Add cache dumps for OpenRS2 version ${{ inputs.cache_version }}" || echo "No changes to commit"
          git push origin update-${{ inputs.cache_version }} --force
      # - name: Create Pull Request
      #   uses: peter-evans/create-pull-request@v6
      #   with:
      #     branch: update-${{ inputs.cache_version }}
      #     title: "Update cache dumps to version ${{ inputs.cache_version }}"
      #     body: |
      #       Automated cache dump update from OpenRS2 archive.
            
      #       **Cache Version:** ${{ inputs.cache_version }}
      #       **Dumps included:**
      #       - Items
      #       - Collision maps
      #       - Height maps
      #       - Item sprites
      #       - Map images
      #       - NPCs
      #       - Objects
      #       - Sprites
            
      #       Generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      #     labels: automated,cache-update